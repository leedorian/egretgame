var __reflect=this&&this.__reflect||function(t,e,o){t.__class__=e,o?o.push(e):o=[e],t.__types__=t.__types__?o.concat(t.__types__):o},__extends=this&&this.__extends||function(t,e){function o(){this.constructor=t}for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);o.prototype=e.prototype,t.prototype=new o},__awaiter=this&&this.__awaiter||function(t,e,o,i){return new(o||(o=Promise))(function(n,r){function s(t){try{l(i.next(t))}catch(e){r(e)}}function a(t){try{l(i["throw"](t))}catch(e){r(e)}}function l(t){t.done?n(t.value):new o(function(e){e(t.value)}).then(s,a)}l((i=i.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function o(t){return function(e){return i([t,e])}}function i(o){if(n)throw new TypeError("Generator is already executing.");for(;l;)try{if(n=1,r&&(s=r[2&o[0]?"return":o[0]?"throw":"next"])&&!(s=s.call(r,o[1])).done)return s;switch(r=0,s&&(o=[0,s.value]),o[0]){case 0:case 1:s=o;break;case 4:return l.label++,{value:o[1],done:!1};case 5:l.label++,r=o[1],o=[0];continue;case 7:o=l.ops.pop(),l.trys.pop();continue;default:if(s=l.trys,!(s=s.length>0&&s[s.length-1])&&(6===o[0]||2===o[0])){l=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){l.label=o[1];break}if(6===o[0]&&l.label<s[1]){l.label=s[1],s=o;break}if(s&&l.label<s[2]){l.label=s[2],l.ops.push(o);break}s[2]&&l.ops.pop(),l.trys.pop();continue}o=e.call(t,l)}catch(i){o=[6,i],r=0}finally{n=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}var n,r,s,a,l={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return a={next:o(0),"throw":o(1),"return":o(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a},Block=function(t){function e(e){var o=t.call(this)||this;return o.touchEnabled=!0,o._currentState=e.state,o.width=e.width,o.height=e.height,console.log(o.width+"|"+o.height),o._draw(),o.addEventListener(egret.TouchEvent.TOUCH_BEGIN,o._onTouch,o),o}return __extends(e,t),e.prototype._draw=function(){var t,e=BlockColor.unClickable,o=BlockColor.clickable;0===this._currentState?(t=BlockColor.unClickable,e=BlockColor.clickable):1===this._currentState?t=BlockColor.clickable:2===this._currentState&&(t=BlockColor.clicked),this.graphics.lineStyle(1,o),this.graphics.beginFill(t,1),this.graphics.drawRect(0,0,this.width,this.height),1===this._currentState&&(o=BlockColor.unClickable)},e.prototype._onTouch=function(t){if(1===this._currentState){this.state="clicked";var e=new GameEvents.BlockEvent(GameEvents.BlockEvent.HIT);this.dispatchEvent(e)}},e.prototype.move=function(t,e){void 0===e&&(e="down"),this._speed=t,"up"===e&&(this._speed=-t),this._dir=e,egret.startTick(this._moveBlock,this)},e.prototype.stop=function(){egret.stopTick(this._moveBlock,this)},e.prototype._moveBlock=function(){return"down"===this._dir?this.y>=Utils.getStageHeight()?this._triggerMovedOutEvent():this._setY():this.y<=-this.height?this._triggerMovedOutEvent():this._setY(),!1},e.prototype._setY=function(){var t=this.y;this.y=t+this._speed},e.prototype._triggerMovedOutEvent=function(){console.log(this.y+this.height);var t=!1,e=new GameEvents.BlockEvent(GameEvents.BlockEvent.MOVED_OUT);1===this._currentState&&(t=!0),e.missed=t,this.dispatchEvent(e)},Object.defineProperty(e.prototype,"state",{get:function(){var t;return t=BlockState[this._currentState]},set:function(t){this._currentState=BlockState[t],this.graphics.clear(),this._draw()},enumerable:!0,configurable:!0}),e}(egret.Sprite);__reflect(Block.prototype,"Block");var BlocksColumn=function(t){function e(e){var o=t.call(this)||this;return o._blocks=[],o._speed=1,o._creatingRowIndex=0,o._dir=e.dir,o._speed=e.speed,o.name=e.name,o._index=parseInt(o.name.split("_")[1],10),o._draw(),o}return __extends(e,t),e.prototype._draw=function(){for(var t="down"===this._dir?-1:0,e="down"===this._dir?Utils.rows:Utils.rows+1,o=t;e>o;o++){this._creatingRowIndex="down"===this._dir?o+1:o;var i=this._createBlock({state:Utils.getRowBlockState(this._creatingRowIndex)[this._index]});i.y=o*i.height,this.addChild(i),this._blocks.push(i)}console.log(this._blocks)},e.prototype._createBlock=function(t){var e=Utils.getBlockWidth(),o=Utils.getBlockHeight(),i={width:e,height:o,state:t.state},n=new Block(i);return n.addEventListener(GameEvents.BlockEvent.MOVED_OUT,this._onMovedOut,this),n},e.prototype._onMovedOut=function(t){var e=t.target,o=!1;if(e.removeEventListener(GameEvents.BlockEvent.MOVED_OUT,this._onMovedOut,this),"down"===this._dir?this._blocks.pop():this._blocks.shift(),e.stop(),this.removeChild(e),e=null,o)this.stop();else{console.log(this._creatingRowIndex);var i=this._createBlock({state:Utils.getRowBlockState(this._creatingRowIndex)[this._index]});this._creatingRowIndex++,this.addChild(i),"down"===this._dir?i.y=this._blocks[0].y-i.height+this._speed:i.y=this._blocks[this._blocks.length-1].y+i.height-this._speed,console.log(i.y),i.move(this._speed,this._dir),"down"===this._dir?this._blocks.unshift(i):this._blocks.push(i)}},e.prototype.move=function(){for(var t=this._blocks,e=0;e<t.length;e++)t[e].move(this._speed,this._dir)},e.prototype.stop=function(){console.log("stop");for(var t=0;t<this._blocks.length;t++)this._blocks[t].stop()},e}(egret.Sprite);__reflect(BlocksColumn.prototype,"BlocksColumn");var BlockState;!function(t){t[t.unclickable=0]="unclickable",t[t.clickable=1]="clickable",t[t.clicked=2]="clicked"}(BlockState||(BlockState={}));var BlockColor;!function(t){t[t.unClickable=16777215]="unClickable",t[t.clickable=0]="clickable",t[t.clicked=255]="clicked"}(BlockColor||(BlockColor={}));var GameMode;!function(t){t[t.BI_DIR=0]="BI_DIR",t[t.DOWN=1]="DOWN",t[t.UP=2]="UP"}(GameMode||(GameMode={}));var GameLevel;!function(t){t[t.EASY=0]="EASY",t[t.NORMAL=1]="NORMAL",t[t.HARD=2]="HARD"}(GameLevel||(GameLevel={}));var GameEvents;!function(t){var e=function(t){function e(e,o,i){void 0===o&&(o=!0),void 0===i&&(i=!1);var n=t.call(this,e,o,i)||this;return n.missed=!1,n}return __extends(e,t),e.MOVED_OUT="movedout",e.MISSED="missed",e.HIT="hit",e}(egret.Event);t.BlockEvent=e,__reflect(e.prototype,"GameEvents.BlockEvent")}(GameEvents||(GameEvents={}));var GameScene=function(t){function e(e){var o=t.call(this)||this;return o._score=0,o._blockColumns=[],o._mode=e.mode,o._level=e.level,o._calculateColsRows(),o._drawColumns(),o._drawScore(),o.addEventListener(GameEvents.BlockEvent.MOVED_OUT,o._onMovedOut,o,!0),o.addEventListener(GameEvents.BlockEvent.HIT,o._onHit,o,!0),o}return __extends(e,t),e.prototype._drawColumns=function(){for(var t,e=["up","down"],o=Utils.getBlockWidth(),i=0;i<Utils.columns;i++){var n="up";this._mode===GameMode.BI_DIR?n=e[Math.floor(2*Math.random())]:this._mode===GameMode.DOWN&&(n=e[1]),t=new BlocksColumn({dir:n,speed:Math.floor(Math.random()*Utils.columns+1),name:"col_"+i}),t.x=i*o,this.addChild(t),this._blockColumns.push(t)}},e.prototype._calculateColsRows=function(){var t=48,e=48,o=Utils.getStageWidth(),i=(Utils.getStageHeight(),Math.floor(o/t)),n=Math.floor(o/e);this._level===GameLevel.EASY?(Utils.columns=4,Utils.rows=6):this._level===GameLevel.NORMAL?(Utils.columns=5,Utils.rows=7):this._level===GameLevel.HARD&&(Utils.columns=6,Utils.rows=8),Utils.columns>i&&(Utils.columns=i),Utils.rows>n&&(Utils.rows=n)},e.prototype._drawScore=function(){var t=new egret.TextField;t.width=Utils.getStageWidth(),t.y=.2*Utils.getStageHeight(),t.height=30,t.textAlign=egret.HorizontalAlign.CENTER,t.verticalAlign=egret.VerticalAlign.MIDDLE,t.textColor=16777215,t.bold=!0,t.strokeColor=255,t.stroke=2,t.text=this._score.toString(),this._scoreText=t,this.addChild(this._scoreText)},e.prototype._onMovedOut=function(t){},e.prototype._onHit=function(t){this._score++,this._scoreText.text=this._score.toString()},e.prototype.gameStart=function(){for(var t=0;t<this._blockColumns.length;t++)this._blockColumns[t].move()},e}(egret.Sprite);__reflect(GameScene.prototype,"GameScene");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.lifecycle.addLifecycleListener(function(t){t.onUpdate=function(){}}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},this.runGame()["catch"](function(t){console.log(t)})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(o){switch(o.label){case 0:return[4,this.loadResource()];case 1:return o.sent(),this.createGameScene(),[4,RES.getResAsync("description_json")];case 2:return t=o.sent(),this.startAnimation(t),[4,platform.login()];case 3:return o.sent(),[4,platform.getUserInfo()];case 4:return e=o.sent(),console.log(e),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(o){switch(o.label){case 0:return o.trys.push([0,3,,4]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return o.sent(),[4,RES.loadGroup("preload",0,t)];case 2:return o.sent(),this.stage.removeChild(t),[3,4];case 3:return e=o.sent(),console.error(e),[3,4];case 4:return[2]}})})},e.prototype.createGameScene=function(){this.stage.setContentSize(window.innerWidth,window.innerHeight);var t=this.createBitmapByName("bg_jpg");this.addChild(t);var e=this.stage.stageWidth,o=this.stage.stageHeight;t.width=e,t.height=o;var i=new egret.Shape;i.graphics.beginFill(0,.5),i.graphics.drawRect(0,0,e,172),i.graphics.endFill(),i.y=33,this.addChild(i);var n=this.createBitmapByName("egret_icon_png");this.addChild(n),n.x=26,n.y=33;var r=new egret.Shape;r.graphics.lineStyle(2,16777215),r.graphics.moveTo(0,0),r.graphics.lineTo(0,117),r.graphics.endFill(),r.x=172,r.y=61,this.addChild(r);var s=new egret.TextField;s.textColor=16777215,s.width=e-172,s.textAlign="center",s.text="Hello Egret",s.size=24,s.x=172,s.y=80,this.addChild(s);var a=new egret.TextField;this.addChild(a),a.alpha=0,a.width=e-172,a.textAlign=egret.HorizontalAlign.CENTER,a.size=24,a.textColor=16777215,a.x=172,a.y=135,this.textfield=a;var l=new GameScene({mode:GameMode.BI_DIR,level:GameLevel.EASY});this.addChild(l),l.gameStart()},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,o=RES.getRes(t);return e.texture=o,e},e.prototype.startAnimation=function(t){var e=this,o=new egret.HtmlTextParser,i=t.map(function(t){return o.parse(t)}),n=this.textfield,r=-1,s=function(){r++,r>=i.length&&(r=0);var t=i[r];n.textFlow=t;var o=egret.Tween.get(n);o.to({alpha:1},200),o.wait(2e3),o.to({alpha:0},200),o.call(s,e)};s()},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var Utils=function(){function t(){}return t.getBlockWidth=function(){return 0===t._blockWidth&&(t._blockWidth=egret.MainContext.instance.stage.stageWidth/this.columns),t._blockWidth},t.getBlockHeight=function(){return 0===t._blockHeight&&(t._blockHeight=Math.ceil(egret.MainContext.instance.stage.stageHeight/this.rows)),t._blockHeight},t.getStageWidth=function(){return 0===t._stageWidth&&(t._stageWidth=egret.MainContext.instance.stage.stageWidth),t._stageWidth},t.getStageHeight=function(){return 0===t._stageHeight&&(t._stageHeight=egret.MainContext.instance.stage.stageHeight),t._stageHeight},t.getRowBlockState=function(e){if(void 0===t.rowsState[e]){for(var o=[],i=Math.floor(Math.random()*t.columns),n=0;n<t.columns;n++)n===i?o.push(BlockState.clickable):o.push(BlockState.unclickable);return t.rowsState.push(o),o}return t.rowsState[e]},t._blockWidth=0,t._blockHeight=0,t._stageHeight=0,t._stageWidth=0,t.rowsState=[],t.rows=6,t.columns=6,t}();__reflect(Utils.prototype,"Utils");